<!DOCTYPE html>
<meta charset="utf-8">
<title>Test Suite</title>
<link rel="stylesheet" href="../../qunit-2.19.4/qunit-2.19.4.css">
<!-- <link rel="stylesheet" href="https://code.jquery.com/qunit/qunit-2.19.4.css"> -->
<body>
  <div id="qunit"></div>
  <div id="qunit-fixture"></div>
  <!-- <script src="https://code.jquery.com/qunit/qunit-2.19.4.js"></script> -->
  <script src="../../qunit-2.19.4/qunit-2.19.4.js"></script>
  <script src="../../qunit-assert-close-git/qunit-assert-close/qunit-assert-close.js"></script>


  <script src="debug.js"></script>
  <script src="helpers.js"></script>
  <script src="BCLegs.js"></script>
  <script src="BCEndRings.js"></script>
  <script src="BirdcageBuilder.js"></script>

  <!-- see https://www.smashingmagazine.com/2012/06/introduction-to-javascript-unit-testing/ -->


  <script>
  QUnit.module('Full Workflow Tests', function() {

    // TODO - double check all NaN results are correct; try to make some better/more meaningful tests

    QUnit.test('App Defaults Tests', function(assert) {
      /* Test that outputs match closely to Android app with default inputs */

	    bb = new BirdcageBuilder(8, 21.28e6, 0.1, 0, 'lowpass');
		  bb.legs.set_legs_rect(0.1, 0.02);
		  bb.endrings.set_endrings_rect(0.01);
	    bb.endrings.calc_er_mutual_inductance(bb.legs);

      // TODO - NOTE: the units are manually adjusted here, to reflect the app output values:
      //assert.step('TO DO - Output Units???');
      var TEST_TOL = 5e-5; // allowing 0.5 rounding error for 4-digit app outputs
      assert.close(1e9 * bb.legs.leg_self_inductance,       56.0517, TEST_TOL, 'Leg Self Inductance');
      assert.close(1e9 * bb.endrings.er_self_inductance,    51.1163, TEST_TOL, 'EndRing Self Inductance');
      assert.close(1e9 * bb.legs.leg_mutual_inductance,     60.3136, TEST_TOL, 'Leg Mutual Inductance'); // TODO unhardcode index?
      assert.close(1e9 * bb.endrings.er_mutual_inductance[2], 62.2339, TEST_TOL, 'EndRing Mutual Inductance [k=2]');
      //assert.step('TO DO - Capacitor Value');
      assert.close(1e12 * bb.calc_capacitor(), 205.0515, TEST_TOL, 'Capacitor');
      assert.true(bb.calc_capacitor() > 0, 'Sign of Capacitor');
    });

    QUnit.test('App Defaults (Varying Coil Radius)', function(assert) {
      /* Test that outputs match closely to Android app with default inputs */

	    //           constructor(n,       f,  rc,rs,   config) 
	    bb = new BirdcageBuilder(8, 21.28e6, 0.12, 0, 'lowpass');  // 12 cm radius (other defaults stay the same)
		  bb.legs.set_legs_rect(0.1, 0.02);
		  bb.endrings.set_endrings_rect(0.01);
	    bb.endrings.calc_er_mutual_inductance(bb.legs);

      var TEST_TOL = 5e-5; // allowing 0.5 rounding error for 4-digit app outputs
      assert.close(1e9 * bb.legs.leg_self_inductance,       56.0517, TEST_TOL, 'Leg Self Inductance (rc = 12cm (LSI stays same))');
      assert.close(1e9 * bb.endrings.er_self_inductance,    64.7763, TEST_TOL, 'EndRing Self Inductance (rc = 12cm)');
      assert.close(1e9 * bb.legs.leg_mutual_inductance,     59.9066, TEST_TOL, 'Leg Mutual Inductance (rc = 12cm)'); // TODO unhardcode index?
      assert.close(1e9 * bb.endrings.er_mutual_inductance[2], 78.1174, TEST_TOL, 'EndRing Mutual Inductance [k=2] (rc = 12cm)');
      assert.close(1e12 * bb.calc_capacitor(), 171.2614, TEST_TOL, 'Capacitor (rc = 12cm)');
      assert.true(bb.calc_capacitor() > 0, 'Sign of Capacitor (rc = 12cm)');


	    //           constructor(n,       f,  rc,rs,   config) 
	    bb = new BirdcageBuilder(8, 21.28e6, 1.23, 0, 'lowpass');  // 123 cm radius (other defaults stay the same)
		  bb.legs.set_legs_rect(0.1, 0.02);
		  bb.endrings.set_endrings_rect(0.01);
	    bb.endrings.calc_er_mutual_inductance(bb.legs);

      var TEST_TOL = 5e-5; // allowing 0.5 rounding error for 4-digit app outputs
      assert.close(1e9 * bb.legs.leg_self_inductance,       56.0517, TEST_TOL, 'Leg Self Inductance (rc = 123cm (LSI stays same))');
      assert.close(1e9 * bb.endrings.er_self_inductance,    1113.6057, 10*TEST_TOL, 'EndRing Self Inductance (rc = 123cm) ADJUSTED TOLERANCE');
      assert.close(1e9 * bb.legs.leg_mutual_inductance,     56.5239, TEST_TOL, 'Leg Mutual Inductance (rc = 123cm)'); // TODO unhardcode index?
      assert.close(1e9 * bb.endrings.er_mutual_inductance[2], 1250.3521, TEST_TOL, 'EndRing Mutual Inductance [k=2] (rc = 123cm)');
      assert.close(1e12 * bb.calc_capacitor(), 12.9319, TEST_TOL, 'Capacitor (rc = 123cm)');
      assert.true(bb.calc_capacitor() > 0, 'Sign of Capacitor (rc = 123cm)');

      // TODO would be interesting to graph these... like multiple graphs for different changing variables to see the different dependencies

    });


    // TODO repeat -  go through all combinations/defaults in app!

    var PAPER_TEST_TOL = 5e-3; // paper results only have 2 digits after decimal
    // TODO some have 0 or 1 digits (after decimal)

    QUnit.test('BirdcageBuilder 2002-A', function(assert) {
      /* Test against Table 1 results from 2002 Birdcage Builder paper 
       *
       * Chin, Collins, et al. MRM Vol 15(2) 156-163. 2002.
       */

	    //           constructor(n,        f,     rc,     rs,   config) 
	    bb = new BirdcageBuilder(12, 21.25e6, 3.8e-2, 100e-2, 'lowpass');
      assert.step('NOTE - Custom endring arclength');
		  bb.legs.set_legs_rect(10e-2, 0.6e-2); // TODO assuming rectangular? 'a' superscript?
      bb.endrings.er_arclen = 1.98e-2;
		  bb.endrings.set_endrings_rect(0.6e-2);  // TODO - paper specifies endring SEGMENT LENGTH??
	    bb.endrings.calc_er_mutual_inductance(bb.legs);

      // TODO - NOTE: the units are manually adjusted here, to reflect the app output values:
      assert.close(1e12 * bb.calc_capacitor(), 269.54, PAPER_TEST_TOL, 'Paper Capacitor A');

      assert.verifySteps(['NOTE - Custom endring arclength']);
    });





  }); // end all tests

  </script>


</body>
